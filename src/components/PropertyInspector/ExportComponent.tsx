import React, { useState, useMemo } from 'react';
import { Download, Copy, X, Check, FileCode } from 'lucide-react';
import { Button } from '../ui/button';
import { Input } from '../ui/input';
import { Switch } from '../ui/switch';
import { Label } from '../ui/label';
import { ScrollArea } from '../ui/scroll-area';
import { useLanguage } from '@/contexts/LanguageContext';
import { useToast } from '@/hooks/use-toast';
import { InspectorState } from './types';

interface ExportComponentProps {
  state: InspectorState;
  generatedClasses: string;
  onClose: () => void;
}

export const ExportComponent: React.FC<ExportComponentProps> = ({ state, generatedClasses, onClose }) => {
  const { t } = useLanguage();
  const { toast } = useToast();
  const [componentName, setComponentName] = useState('MyComponent');
  const [includeProps, setIncludeProps] = useState(true);
  const [includeComments, setIncludeComments] = useState(true);
  const [copied, setCopied] = useState(false);

  // Generate React component code
  const generatedCode = useMemo(() => {
    const pascalName = componentName.replace(/[^a-zA-Z0-9]/g, '').replace(/^./, c => c.toUpperCase());
    const Tag = state.tag || 'div';
    const isLink = Tag === 'a';
    const isButton = Tag === 'button';

    // Build props interface
    const propsInterface = includeProps ? `
interface ${pascalName}Props {
  children?: React.ReactNode;
  className?: string;${isLink ? '\n  href?: string;' : ''}${isButton ? '\n  onClick?: () => void;\n  disabled?: boolean;' : ''}
}
` : '';

    // Build inline styles if any
    const hasInlineStyles = state.inlineCSS?.trim();
    const styleObject = hasInlineStyles ? `
  const customStyles: React.CSSProperties = {
    ${state.inlineCSS.split(';').filter(s => s.trim()).map(s => {
      const [prop, val] = s.split(':').map(p => p.trim());
      if (!prop || !val) return '';
      // Convert CSS property to camelCase
      const camelProp = prop.replace(/-([a-z])/g, (_, letter) => letter.toUpperCase());
      return `${camelProp}: "${val}"`;
    }).filter(Boolean).join(',\n    ')}
  };
` : '';

    // Build component
    const comments = includeComments ? `/**
 * ${pascalName} Component
 * 
 * Generated by Visual Editor
 * Tailwind Classes: ${generatedClasses || 'none'}
 */
` : '';

    const propsDestructure = includeProps 
      ? `{ children${isLink ? ', href = "#"' : ''}${isButton ? ', onClick, disabled' : ''}, className = "" }: ${pascalName}Props`
      : '';

    const classNameValue = generatedClasses 
      ? includeProps 
        ? `\`${generatedClasses} \${className}\`` 
        : `"${generatedClasses}"`
      : includeProps ? 'className' : '""';

    const elementProps = [
      `className={${classNameValue}}`,
      hasInlineStyles ? 'style={customStyles}' : '',
      isLink ? 'href={href}' : '',
      isButton ? 'onClick={onClick}' : '',
      isButton ? 'disabled={disabled}' : '',
    ].filter(Boolean).join('\n        ');

    const content = state.textContent 
      ? includeProps ? `{children || "${state.textContent}"}` : `"${state.textContent}"`
      : includeProps ? '{children}' : '';

    return `import React from 'react';

${comments}${propsInterface}
export const ${pascalName}${includeProps ? `: React.FC<${pascalName}Props>` : ''} = (${propsDestructure}) => {${styleObject}
  return (
    <${Tag}
        ${elementProps}>
      ${content}
    </${Tag}>
  );
};

export default ${pascalName};
`;
  }, [state, generatedClasses, componentName, includeProps, includeComments]);

  const handleCopy = async () => {
    await navigator.clipboard.writeText(generatedCode);
    setCopied(true);
    toast({
      title: t('export.copied'),
      description: t('export.copiedDesc'),
    });
    setTimeout(() => setCopied(false), 2000);
  };

  const handleDownload = () => {
    const blob = new Blob([generatedCode], { type: 'text/typescript' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${componentName.replace(/[^a-zA-Z0-9]/g, '')}.tsx`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  return (
    <div className="bg-card border border-border rounded-2xl shadow-[var(--shadow-panel)] w-80 max-h-[85vh] flex flex-col overflow-hidden">
      {/* Header */}
      <div className="flex items-center justify-between border-b border-border py-2 px-4 bg-secondary/50 flex-shrink-0">
        <div className="flex items-center gap-1.5">
          <FileCode className="w-3.5 h-3.5 text-primary" />
          <h3 className="text-xs uppercase font-bold text-primary">{t('export.title')}</h3>
        </div>
        <Button variant="ghost" size="icon" className="h-6 w-6" onClick={onClose}>
          <X className="w-3 h-3" />
        </Button>
      </div>

      {/* Options */}
      <div className="p-3 border-b border-border space-y-3">
        <div>
          <Label htmlFor="component-name" className="text-xs text-muted-foreground mb-1.5 block">
            {t('export.componentName')}
          </Label>
          <Input
            id="component-name"
            value={componentName}
            onChange={(e) => setComponentName(e.target.value)}
            className="h-7 text-xs font-mono"
            placeholder="MyComponent"
          />
        </div>

        <div className="flex items-center justify-between">
          <Label htmlFor="include-props" className="text-xs">
            {t('export.includeProps')}
          </Label>
          <Switch
            id="include-props"
            checked={includeProps}
            onCheckedChange={setIncludeProps}
          />
        </div>

        <div className="flex items-center justify-between">
          <Label htmlFor="include-comments" className="text-xs">
            {t('export.includeComments')}
          </Label>
          <Switch
            id="include-comments"
            checked={includeComments}
            onCheckedChange={setIncludeComments}
          />
        </div>
      </div>

      {/* Code Preview */}
      <div className="p-3 flex-1 min-h-0">
        <div className="flex items-center justify-between mb-2">
          <span className="text-[10px] text-muted-foreground uppercase font-medium">
            {t('export.preview')}
          </span>
          <span className="text-[9px] text-muted-foreground font-mono">
            {componentName.replace(/[^a-zA-Z0-9]/g, '')}.tsx
          </span>
        </div>
        <ScrollArea className="h-[280px] rounded-lg border border-border">
          <pre className="p-3 text-[10px] font-mono leading-relaxed bg-neutral-950 text-emerald-400 whitespace-pre-wrap break-all">
            {generatedCode}
          </pre>
        </ScrollArea>
      </div>

      {/* Actions */}
      <div className="p-3 border-t border-border flex gap-2">
        <Button
          variant="outline"
          size="sm"
          className="flex-1 h-8 text-xs gap-1.5"
          onClick={handleCopy}
        >
          {copied ? <Check className="w-3 h-3" /> : <Copy className="w-3 h-3" />}
          {t('export.copyCode')}
        </Button>
        <Button
          size="sm"
          className="flex-1 h-8 text-xs gap-1.5"
          onClick={handleDownload}
        >
          <Download className="w-3 h-3" />
          {t('export.download')}
        </Button>
      </div>
    </div>
  );
};
